@model BMSBT.Models.ViewModels.BillStatusDashboardViewModel

@{
    ViewData["Title"] = "Dashboard - Maintenance Bill";
    Layout = "~/Views/Shared/_LayoutReports.cshtml";
}

<div class="container-fluid">
    <h3>Dashboard - Maintenance Bill</h3>

    <!-- Filter Dropdowns -->
    <div class="row mt-3 mb-3">
        <div class="col-md-3">
            <label for="billingMonth" class="form-label">Billing Month</label>
            <select id="billingMonth" class="form-control">
                <option value="">-- Select Month --</option>
                @foreach (var month in Model.MonthList)
                {
                    <option value="@month.Value" selected="@(month.Value == Model.SelectedMonth)">@month.Text</option>
                }
            </select>
        </div>
        <div class="col-md-3">
            <label for="billingYear" class="form-label">Billing Year</label>
            <select id="billingYear" class="form-control">
                <option value="">-- Select Year --</option>
                @foreach (var year in Model.YearList)
                {
                    <option value="@year.Value" selected="@(year.Value == Model.SelectedYear)">@year.Text</option>
                }
            </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button type="button" id="btnFilter" class="btn btn-primary">Filter</button>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col-md-3">
            <div class="card text-white bg-primary mb-3">
                <div class="card-header">Total Bills</div>
                <div class="card-body">
                    <h4 class="card-title" id="totalBillsCard">@Model.TotalBills</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success mb-3">
                <div class="card-header">Paid</div>
                <div class="card-body">
                    <h4 class="card-title" id="paidCountCard">@Model.PaidCount</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning mb-3">
                <div class="card-header">Paid with Surcharge</div>
                <div class="card-body">
                    <h4 class="card-title" id="paidWithSurchargeCountCard">@Model.PaidWithSurchargeCount</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-danger mb-3">
                <div class="card-header">Unpaid</div>
                <div class="card-body">
                    <h4 class="card-title" id="unpaidCountCard">@Model.UnpaidCount</h4>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-6">
            <h5>Status-wise Bills (Bar Chart)</h5>
            <div style="position: relative; height: 400px;">
                <canvas id="statusBarChart"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <h5>Status-wise Bills (Pie Chart)</h5>
            <div style="position: relative; height: 400px;">
                <canvas id="statusPieChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    let barChart = null;
    let pieChart = null;

    function updateCharts(labels, counts, totalBills, paidCount, paidWithSurchargeCount, unpaidCount) {
        console.log('Updating charts with data:', { labels, counts, totalBills, paidCount, paidWithSurchargeCount, unpaidCount });

        // Update summary cards using IDs
        $('#totalBillsCard').text(totalBills);
        $('#paidCountCard').text(paidCount);
        $('#paidWithSurchargeCountCard').text(paidWithSurchargeCount);
        $('#unpaidCountCard').text(unpaidCount);

        // Destroy existing charts
        if (barChart) {
            barChart.destroy();
        }
        if (pieChart) {
            pieChart.destroy();
        }

        // Update Bar Chart
        const barCanvas = document.getElementById('statusBarChart');
        if (!barCanvas) {
            console.error('Bar chart canvas not found');
            return;
        }

        barChart = new Chart(barCanvas.getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels || [],
                datasets: [{
                    label: 'Number of Bills',
                    data: counts || [],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.6)',
                        'rgba(255, 193, 7, 0.6)',
                        'rgba(220, 53, 69, 0.6)'
                    ],
                    borderColor: [
                        'rgba(40, 167, 69, 1)',
                        'rgba(255, 193, 7, 1)',
                        'rgba(220, 53, 69, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            precision: 0
                        },
                        title: {
                            display: true,
                            text: 'Count'
                        }
                    }
                }
            }
        });

        // Update Pie Chart
        const pieCanvas = document.getElementById('statusPieChart');
        if (!pieCanvas) {
            console.error('Pie chart canvas not found');
            return;
        }

        pieChart = new Chart(pieCanvas.getContext('2d'), {
            type: 'pie',
            data: {
                labels: labels || [],
                datasets: [{
                    data: counts || [],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.7)',
                        'rgba(255, 193, 7, 0.7)',
                        'rgba(220, 53, 69, 0.7)'
                    ],
                    borderColor: '#ffffff',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    function fetchBillData(month, year) {
        if (!month || !year) {
            alert('Please select both Month and Year');
            return;
        }

        console.log('Fetching maintenance bill data for:', month, year);
        const url = '@Url.Action("GetMaintenanceBillStatusData", "Graphs")';
        console.log('AJAX URL:', url);

        $.ajax({
            url: url,
            type: 'POST',
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
            data: { month: month, year: year },
            dataType: 'json',
            success: function (response) {
                console.log('AJAX Success - Full Response:', JSON.stringify(response));
                
                if (!response) {
                    console.error('No response received');
                    alert('No data received from server');
                    return;
                }

                // Handle both camelCase (default) and PascalCase (if configured)
                const labels = response.labels || response.Labels || ["Paid", "Paid with Surcharge", "Unpaid"];
                const data = response.data || response.Data || [0, 0, 0];
                const totalBills = response.totalBills || response.TotalBills || 0;
                const paidCount = response.paidCount || response.PaidCount || 0;
                const paidWithSurchargeCount = response.paidWithSurchargeCount || response.PaidWithSurchargeCount || 0;
                const unpaidCount = response.unpaidCount || response.UnpaidCount || 0;

                console.log('Parsed values:', { labels, data, totalBills, paidCount, paidWithSurchargeCount, unpaidCount });

                if (labels.length === 0 || data.length === 0) {
                    console.warn('Empty labels or data arrays');
                }

                updateCharts(labels, data, totalBills, paidCount, paidWithSurchargeCount, unpaidCount);
            },
            error: function (xhr, status, error) {
                console.error('AJAX Error Details:', {
                    status: status,
                    error: error,
                    statusCode: xhr.status,
                    statusText: xhr.statusText,
                    responseText: xhr.responseText
                });
                alert('Error fetching bill data. Status: ' + xhr.status + ' - ' + error + '\nCheck browser console for details.');
            }
        });
    }

    $(document).ready(function () {
        console.log('Document ready - initializing charts');
        console.log('jQuery version:', $.fn.jquery);
        console.log('Chart.js available:', typeof Chart !== 'undefined');

        // Ensure Chart.js is loaded
        if (typeof Chart === 'undefined') {
            console.error('Chart.js is not loaded!');
            alert('Chart.js library failed to load. Please refresh the page.');
            return;
        }

        // Initial load with existing model data
        const statusLabels = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Labels ?? new List<string>()));
        const statusCounts = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Counts ?? new List<int>()));
        
        console.log('Initial data:', { statusLabels, statusCounts });

        // Always initialize charts, even with zero data
        const initialLabels = statusLabels && statusLabels.length > 0 ? statusLabels : ["Paid", "Paid with Surcharge", "Unpaid"];
        const initialCounts = statusCounts && statusCounts.length > 0 ? statusCounts : [0, 0, 0];

        updateCharts(
            initialLabels,
            initialCounts,
            @Model.TotalBills,
            @Model.PaidCount,
            @Model.PaidWithSurchargeCount,
            @Model.UnpaidCount
        );

        // Filter button click
        $('#btnFilter').on('click', function (e) {
            e.preventDefault();
            console.log('Filter button clicked');
            const month = $('#billingMonth').val();
            const year = $('#billingYear').val();
            console.log('Selected values:', { month, year });
            
            if (!month || !year) {
                alert('Please select both Month and Year');
                return;
            }
            
            fetchBillData(month, year);
        });

        // Auto-filter on dropdown change
        $('#billingMonth, #billingYear').on('change', function () {
            const month = $('#billingMonth').val();
            const year = $('#billingYear').val();
            console.log('Dropdown changed:', { month, year });
            if (month && year) {
                fetchBillData(month, year);
            }
        });
    });
</script>
