@model IEnumerable<BMSBT.ViewModels.SectorCustomersViewModel>
@using System.Text.Json
@{
    Layout = "~/Views/Shared/_LayoutEBills.cshtml";
    var accordionId = "accordionSectors";
    int count = 0;
    var selectedProject = ViewBag.SelectedProject as string;
    var btNoSearch = ViewBag.BTNoSearch as string;
    var projects = ViewBag.Projects as List<string> ?? new List<string>();
}

@{
    string operatorJson = Context.Session.GetString("OperatorSetupDetail");
    string operatorName = "", billingMonth = "", billingYear = "";

    if (!string.IsNullOrEmpty(operatorJson))
    {
        var setup = JsonSerializer.Deserialize<Dictionary<string, string>>(operatorJson);
        operatorName = setup.ContainsKey("OperatorName") ? setup["OperatorName"] : "";
        billingMonth = setup.ContainsKey("BillingMonth") ? setup["BillingMonth"] : "";
        billingYear = setup.ContainsKey("BillingYear") ? setup["BillingYear"] : "";
    }
}



<!-- Include Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

<!-- Optional: Loading overlay -->
<style>
    #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.7);
        z-index: 2000;
        display: none; /* hidden initially */
        align-items: center;
        justify-content: center;
    }
    #loadingOverlay .spinner-border {
        width: 3rem;
        height: 3rem;
    }
</style>

<div id="loadingOverlay">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- Search / filter form -->


<div class="mb-3">
    <span class="fw-bold text-primary">Operator:</span> @operatorName |
    <span class="fw-bold text-primary">Billing Month:</span> @billingMonth |
    <span class="fw-bold text-primary">Billing Year:</span> @billingYear
</div>



<form method="get" asp-action="GenerateBill" asp-controller="SGCustomers">
    <div class="row mb-3">
        <div class="col-md-4">
            <label class="form-label fw-bold">Bills Not Generated</label>
            <select name="selectedProject" class="form-select" onchange="this.form.submit()">
                <option value="">-- Select Project --</option>
                @foreach (var project in projects)
                {
                    if (project == selectedProject)
                    {
                        <option value="@project" selected>@project</option>
                    }
                    else
                    {
                        <option value="@project">@project</option>
                    }
                }
            </select>
        </div>

        @* Show search only if project is selected *@
        @if (!string.IsNullOrEmpty(selectedProject))
        {
            <div class="col-md-4">
                <label class="form-label fw-bold">Search by BTNo:</label>
                <input type="text" name="btNoSearch" value="@btNoSearch" class="form-control" placeholder="Enter BTNo..." />
            </div>

            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">Search</button>
            </div>
        }
    </div>
    <button id="createRecordelec" type="button" class="btn btn-success mb-3" style="width:150px">
        Generate Bill
    </button>
</form>

<div class="accordion" id="@accordionId">
    @foreach (var group in Model)
    {
        var collapseId = $"collapse_{count}";
        var headingId = $"heading_{count}";
        <div class="accordion-item">
            <h2 class="accordion-header" id="@headingId">
                <button class="accordion-button collapsed" type="button"
                        data-bs-toggle="collapse" data-bs-target="#@collapseId"
                        aria-expanded="false" aria-controls="@collapseId">
                    Sector: @group.Sector <span class="ms-3 text-muted">(Total: @group.Customers.Count)</span>
                </button>
            </h2>
            <div id="@collapseId" class="accordion-collapse collapse"
                 aria-labelledby="@headingId" data-bs-parent="#@accordionId">
                <div class="accordion-body p-0">
                    <table class="table table-bordered table-striped mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>
                                    <input type="checkbox"
                                           onclick="toggleGroupCheckboxes(this, '@collapseId')" />
                                </th>
                                <th>BT Number</th>
                                <th>Customer Name</th>
                                <th>CNIC No</th>
                                <th>Mobile No</th>
                                <th>SubProject</th>
                                <th>Block</th>
                                <th>Bill Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var customer in group.Customers)
                            {
                                <tr ondblclick="window.location.href='@Url.Action("ViewCustomer", "SGCustomers", new { id = customer.Uid })'"
                                    style="cursor: pointer;">
                                    <td>
                                        @* Each checkbox has name="selectedCustomers" so we can select all checked later *@
                                        <input type="checkbox" name="selectedCustomers"
                                               value="@customer.Uid"
                                               class="checkbox-@collapseId" />
                                    </td>
                                    <td>@customer.Btno</td>
                                    <td>@customer.CustomerName</td>
                                    <td>@customer.Cnicno</td>
                                    <td>@customer.MobileNo</td>
                                    <td>@customer.SubProject</td>
                                    <td>@customer.Block</td>
                                    <td>@customer.BillStatus</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        count++;
    }
</div>

<!-- Include jQuery first, then Bootstrap JS bundle -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJ+Y3TSLRmXX2mY+6pLDcXul5/6p1w5IBXtk=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Toggle checkboxes in one accordion group
    function toggleGroupCheckboxes(source, groupId) {
        // groupId is collapseId, e.g. "collapse_0"
        // checkboxes have class "checkbox-collapse_0"
        var selector = '.checkbox-' + groupId;
        var checked = source.checked;
        document.querySelectorAll(selector).forEach(cb => {
            cb.checked = checked;
        });
    }

    $(document).ready(function () {
        // Handle Generate Bill button click
        $('#createRecordelec').click(function () {
            // Collect all checked checkboxes named "selectedCustomers"
            var selectedIds = $('input[name="selectedCustomers"]:checked')
                .map(function () {
                    var v = parseInt($(this).val());
                    return isNaN(v) ? null : v;
                })
                .get()
                .filter(id => id !== null);

            if (selectedIds.length === 0) {
                alert('No records selected.');
                return;
            }

            // Show loading overlay if desired
            $('#loadingOverlay').show();

            $.ajax({
                url: '@Url.Action("GenerateElectricityBills", "EBillU")', // adjust controller/action
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ selectedIds: selectedIds }),
                success: function (response) {
                    $('#loadingOverlay').hide();

                    if (response.success || response.Success) {
                        // If you have a #resultsTable to show results:
                        if ($('#resultsTable').length) {
                            $('#resultsTable tbody').empty();
                            var results = Array.isArray(response.results) ? response.results : [];
                            results.forEach(function (result, index) {
                                $('#resultsTable tbody').append(
                                    `<tr><td>${index + 1}</td><td>${result}</td></tr>`
                                );
                            });
                            // Uncheck all for next time
                            $('input[name="selectedCustomers"]').prop('checked', false);
                            // Optionally collapse all accordions or reset states
                            $('#resultsContainer').show();
                        }
                        alert('Operation Completed Successfully');
                    } else {
                        var msg = response.message || response.Message || 'Warning occurred.';
                        alert('Warning: ' + msg);
                    }
                },
                error: function () {
                    $('#loadingOverlay').hide();
                    alert('An error occurred while creating electricity bills.');
                }
            });
        });
    });
</script>
