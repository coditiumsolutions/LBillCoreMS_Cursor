@{
    ViewData["Title"] = "Create";
    Layout = "~/Views/Shared/_LayoutFine.cshtml";
}

@model BMSBT.Models.Fine
@{
    ViewData["Title"] = "Create Fine";
}

<style>
    /* Hide number input spinners */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    input[type="number"] {
        -moz-appearance: textfield;
    }

    /* Ensure consistent height/appearance for inputs and dropdowns */
    input.form-control,
    select.form-control {
        height: 38px;
        padding: .375rem .75rem;
        line-height: 1.5;
    }
    
    .is-invalid {
        border-color: #dc3545;
    }
</style>

<form asp-action="Create" method="post" id="fineForm">
    <div class="container">
        @if (ViewContext.HttpContext.Request.Method == "POST" && !ViewData.ModelState.IsValid)
        {
            <div class="alert alert-danger" role="alert">
                <h5><strong>Please correct the following errors:</strong></h5>
                <ul class="mb-0">
                    @foreach (var key in ViewData.ModelState.Keys)
                    {
                        var errors = ViewData.ModelState[key].Errors;
                        if (errors.Count > 0)
                        {
                            foreach (var error in errors)
                            {
                                var fieldName = key;
                                // Convert field names to readable format
                                if (fieldName == "BTNo" || fieldName == "btNo") fieldName = "BT No";
                                else if (fieldName == "FineService") fieldName = "Fine Service";
                                else if (fieldName == "FineMonth") fieldName = "Fine Month";
                                else if (fieldName == "FineYear") fieldName = "Fine Year";
                                else if (fieldName == "DateFine") fieldName = "Fine Date";
                                else if (fieldName == "FineEnterDate") fieldName = "Fine Enter Date";
                                else if (fieldName == "FineAmount") fieldName = "Fine Amount";
                                else if (fieldName == "WaivedAmount") fieldName = "Waived Amount";
                                else if (fieldName == "AdjustmentAmount") fieldName = "Adjustment Amount";
                                else if (fieldName == "FineToCharge") fieldName = "Fine to Charge";
                                else if (fieldName == "ProjectName") fieldName = "Project Name";
                                else if (fieldName == "CustomerName") fieldName = "Customer Name";
                                else if (fieldName == "FineEnteredBy") fieldName = "Fine Entered By";
                                
                                <li><strong>@fieldName:</strong> @error.ErrorMessage</li>
                            }
                        }
                    }
                </ul>
            </div>
        }

        <!-- Section 1: Enter BTNo -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Search Customer</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-2">Enter BTNo</div>
                    <div class="col-md-4">
                        <input type="text" id="btnoInput" class="form-control" placeholder="Search BT No" />
                    </div>
                    <div class="col-md-2">Fine Service</div>
                    <div class="col-md-4">
                        <select id="projectSelect" asp-for="FineService" class="form-control">
                            <option value="">-- Fine Service --</option>
                            <option value="Electricity">Electricity</option>
                            <option value="Maintenance">Maintenance</option>
                        </select>
                        <span asp-validation-for="FineService" class="text-danger"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <button type="button" class="btn btn-info" onclick="fetchCustomer()">Search</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 2: Dropdown Fields -->
        <div class="card mb-3">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Fine Information</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-2"><label asp-for="FineMonth" class="form-label">Fine Month</label></div>
                    <div class="col-md-4">
                        <select asp-for="FineMonth" class="form-control">
                            <option value="">-- Select Month --</option>
                            <option>January</option>
                            <option>February</option>
                            <option>March</option>
                            <option>April</option>
                            <option>May</option>
                            <option>June</option>
                            <option>July</option>
                            <option>August</option>
                            <option>September</option>
                            <option>October</option>
                            <option>November</option>
                            <option>December</option>
                        </select>
                        <span asp-validation-for="FineMonth" class="text-danger"></span>
                    </div>

                    <div class="col-md-2"><label asp-for="FineYear" class="form-label">Fine Year</label></div>
                    <div class="col-md-4">
                        <select asp-for="FineYear" class="form-control">
                            <option value="">-- Select Year --</option>
                            @{
                                int startYear = 2020;
                                int currentYear = DateTime.Now.Year;
                                for (int i = startYear; i <= currentYear + 2; i++)
                                {
                                    <option value="@i" selected="@(i == currentYear ? "selected" : null)">@i</option>
                                }
                            }
                        </select>
                        <span asp-validation-for="FineYear" class="text-danger"></span>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-2"><label asp-for="Department" class="form-label">Department</label></div>
                    <div class="col-md-4">
                        <select asp-for="Department" class="form-control">
                            <option value="">-- Select Department --</option>
                            <option>Accounts</option>
                            <option>Operations</option>
                            <option>Security</option>
                            <option>Maintenance</option>
                            <option>Electricity</option>
                            <option>Others</option>
                        </select>
                        <span asp-validation-for="Department" class="text-danger"></span>
                    </div>

                    <div class="col-md-2"><label asp-for="FineType" class="form-label">Fine Type</label></div>
                    <div class="col-md-4">
                        <select asp-for="FineType" class="form-control">
                            <option value="">-- Select Fine Type --</option>
                            <option>Late Payment</option>
                            <option>Violation</option>
                            <option>Illegal Construction</option>
                            <option>Non-Payment</option>
                            <option>Overuse</option>
                            <option>Other</option>
                        </select>
                        <span asp-validation-for="FineType" class="text-danger"></span>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-3"><label asp-for="FineAmount" class="form-label">Fine Amount</label></div>
                    <div class="col-md-3">
                        <input asp-for="FineAmount" id="FineAmount" type="number" step="1" class="form-control" />
                        <span asp-validation-for="FineAmount" class="text-danger"></span>
                    </div>

                    <div class="col-md-3"><label asp-for="WaivedAmount" class="form-label">Waived Amount</label></div>
                    <div class="col-md-3">
                        <input asp-for="WaivedAmount" id="WaivedAmount" type="number" step="1" class="form-control" />
                        <span asp-validation-for="WaivedAmount" class="text-danger"></span>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-3"><label asp-for="AdjustmentAmount" class="form-label">Adjustment Amount</label></div>
                    <div class="col-md-3">
                        <input asp-for="AdjustmentAmount" id="AdjustmentAmount" type="number" step="1" class="form-control" />
                        <span asp-validation-for="AdjustmentAmount" class="text-danger"></span>
                    </div>

                    <div class="col-md-3"><label asp-for="FineToCharge" class="form-label">Fine to Charge</label></div>
                    <div class="col-md-3">
                        <input asp-for="FineToCharge" id="FineToCharge" type="number" step="1" class="form-control" value="0" readonly />
                        <span asp-validation-for="FineToCharge" class="text-danger"></span>
                        <small class="text-muted">Auto-calculated: Fine Amount - Waived Amount + Adjustment Amount</small>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-2"><label asp-for="DateFine" class="form-label">Fine Date</label></div>
                    <div class="col-md-4">
                        <input asp-for="DateFine" type="date" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                        <span asp-validation-for="DateFine" class="text-danger"></span>
                    </div>

                    <div class="col-md-2"><label asp-for="FineEnterDate" class="form-label">Fine Enter Date</label></div>
                    <div class="col-md-4">
                        <input asp-for="FineEnterDate" type="date" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                        <span asp-validation-for="FineEnterDate" class="text-danger"></span>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-2"><label asp-for="Comments" class="form-label">Comments</label></div>
                    <div class="col-md-10">
                        <input asp-for="Comments" class="form-control" />
                        <span asp-validation-for="Comments" class="text-danger"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 3: Remaining Fields -->
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Customer & Fine Details</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-2"><label asp-for="BTNo" class="form-label">BT No</label></div>
                    <div class="col-md-4">
                        <input asp-for="BTNo" id="BTNo" class="form-control" />
                        <span asp-validation-for="BTNo" class="text-danger"></span>
                    </div>

                    <div class="col-md-2"><label asp-for="ProjectName" class="form-label">Project Name</label></div>
                    <div class="col-md-4"><input asp-for="ProjectName" id="ProjectName" class="form-control" /></div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-2"><label asp-for="CustomerName" class="form-label">Customer Name</label></div>
                    <div class="col-md-4"><input asp-for="CustomerName" id="CustomerName" class="form-control" /></div>

                    <div class="col-md-2"><label asp-for="Block" class="form-label">Block</label></div>
                    <div class="col-md-4"><input asp-for="Block" id="Block" class="form-control" /></div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-2"><label asp-for="Sector" class="form-label">Sector</label></div>
                    <div class="col-md-4"><input asp-for="Sector" id="Sector" class="form-control" /></div>

                    <div class="col-md-2"><label asp-for="FineEnteredBy" class="form-label">Fine Entered By</label></div>
                    <div class="col-md-4">
                        <input asp-for="FineEnteredBy" class="form-control" readonly />
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-2"><label asp-for="History" class="form-label">History</label></div>
                    <div class="col-md-10"><textarea asp-for="History" class="form-control" readonly></textarea></div>
                </div>
            </div>
        </div>

        <!-- Submit -->
        <div class="row mt-4">
            <div class="col-md-12 text-center">
                <button type="submit" class="btn btn-primary">Save Fine</button>
            </div>
        </div>
    </div>
</form>

<script>
    function fetchCustomer() {
        const btNo = document.getElementById("btnoInput").value.trim();
        const project = document.getElementById("projectSelect").value;

        if (!btNo || !project) {
            alert("Please enter BTNo and select Fine Service");
            return;
        }

        fetch(`/Fine/GetCustomerByBTNo?btNo=${btNo}&project=${project}`)
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert(data.message || "Customer not found.");
                    clearCustomerFields();
                    return;
                }

                const model = data.model;
                document.getElementById("ProjectName").value = model.projectName || "";
                document.getElementById("CustomerName").value = model.customerName || "";
                document.getElementById("Block").value = model.block || "";
                document.getElementById("Sector").value = model.sector || "";
                document.getElementById("BTNo").value = model.btNo || "";
            })
            .catch(error => {
                console.error("Error:", error);
                alert("An error occurred while fetching customer data.");
                clearCustomerFields();
            });
    }

    function clearCustomerFields() {
        document.getElementById("ProjectName").value = "";
        document.getElementById("CustomerName").value = "";
        document.getElementById("Block").value = "";
        document.getElementById("Sector").value = "";
        document.getElementById("BTNo").value = "";

        const monthSelect = document.querySelector('select[name="FineMonth"]');
        if (monthSelect) monthSelect.value = "";

        const yearSelect = document.querySelector('select[name="FineYear"]');
        if (yearSelect) yearSelect.value = "";

        const enteredByInput = document.querySelector('input[name="FineEnteredBy"]');
        if (enteredByInput) enteredByInput.value = "";
    }
</script>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function () {
            // Auto-calculate Fine to Charge = Fine Amount - Waived Amount + Adjustment Amount
            function calculateFineToCharge() {
                var fineAmount = parseFloat($('#FineAmount').val()) || 0;
                var waivedAmount = parseFloat($('#WaivedAmount').val()) || 0;
                var adjustmentAmount = parseFloat($('#AdjustmentAmount').val()) || 0;
                var fineToCharge = fineAmount - waivedAmount + adjustmentAmount;
                
                // Ensure non-negative value
                if (fineToCharge < 0) {
                    fineToCharge = 0;
                }
                
                $('#FineToCharge').val(fineToCharge);
            }
            
            // Calculate when Fine Amount, Waived Amount, or Adjustment Amount changes
            $('#FineAmount, #WaivedAmount, #AdjustmentAmount').on('input change', function() {
                calculateFineToCharge();
            });
            
            // Initial calculation on page load
            calculateFineToCharge();
            
            // Handle form submission with validation
            $('#fineForm').on('submit', function (e) {
                var isValid = true;
                var missingFields = [];

                // Check all required fields using name attribute (ASP.NET Core generates these)
                var requiredFields = [
                    { name: 'FineService', displayName: 'Fine Service' },
                    { name: 'FineMonth', displayName: 'Fine Month' },
                    { name: 'FineYear', displayName: 'Fine Year' },
                    { name: 'Department', displayName: 'Department' },
                    { name: 'FineType', displayName: 'Fine Type' },
                    { name: 'FineAmount', displayName: 'Fine Amount', isNumber: true },
                    { name: 'WaivedAmount', displayName: 'Waived Amount', isNumber: true },
                    { name: 'AdjustmentAmount', displayName: 'Adjustment Amount', isNumber: true },
                    { name: 'FineToCharge', displayName: 'Fine to Charge', isNumber: true },
                    { name: 'DateFine', displayName: 'Fine Date' },
                    { name: 'FineEnterDate', displayName: 'Fine Enter Date' },
                    { name: 'BTNo', displayName: 'BT No' },
                    { name: 'ProjectName', displayName: 'Project Name' },
                    { name: 'CustomerName', displayName: 'Customer Name' },
                    { name: 'Block', displayName: 'Block' },
                    { name: 'Sector', displayName: 'Sector' }
                ];

                requiredFields.forEach(function(field) {
                    var $field = $('[name="' + field.name + '"]');
                    var value = $field.val();
                    
                    if (field.isNumber) {
                        // For number fields, check if value is empty or invalid
                        if (value === '' || value === null || isNaN(value)) {
                            missingFields.push(field.displayName);
                            isValid = false;
                            $field.addClass('is-invalid');
                        } else {
                            var numValue = parseFloat(value);
                            // FineAmount must be > 0, others can be >= 0
                            if (field.name === 'FineAmount' && numValue <= 0) {
                                missingFields.push(field.displayName + ' (must be greater than 0)');
                                isValid = false;
                                $field.addClass('is-invalid');
                            } else if (numValue < 0) {
                                missingFields.push(field.displayName + ' (cannot be negative)');
                                isValid = false;
                                $field.addClass('is-invalid');
                            } else {
                                $field.removeClass('is-invalid');
                            }
                        }
                    } else {
                        if (!value || (typeof value === 'string' && value.trim() === '')) {
                            missingFields.push(field.displayName);
                            isValid = false;
                            $field.addClass('is-invalid');
                        } else {
                            $field.removeClass('is-invalid');
                        }
                    }
                });

                if (!isValid) {
                    e.preventDefault();
                    var message = 'Please fill in the following required fields:\n\n' + missingFields.join('\n');
                    alert('Validation Error:\n\n' + message);
                    
                    // Scroll to first invalid field
                    $('html, body').animate({
                        scrollTop: $('.is-invalid').first().offset().top - 100
                    }, 500);
                    
                    return false;
                }
            });

            // Remove invalid class on input
            $('input, select').on('input change', function () {
                $(this).removeClass('is-invalid');
            });
        });
    </script>
}
