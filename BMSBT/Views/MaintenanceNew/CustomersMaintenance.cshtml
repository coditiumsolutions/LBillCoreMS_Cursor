@model BMSBT.ViewModels.MaintenanceCustomerFilterViewModel

@{
    ViewData["Title"] = "Maintenance Customers";
    Layout = "~/Views/Shared/_LayoutMaintBills.cshtml";
}

<h3>Maintenance Customers</h3>

<div class="card mb-3">
    <div class="card-body">
        <div class="form-row">
            <div class="form-group col-md-4">
                <label for="projectFilter">Project</label>
                <select id="projectFilter" class="form-control">
                    <option value="">-- All Projects --</option>
                    @foreach (var project in Model.Projects)
                    {
                        <option value="@project">@project</option>
                    }
                </select>
            </div>
            <div class="form-group col-md-4">
                <label for="blockFilter">Block</label>
                <select id="blockFilter" class="form-control">
                    <option value="">-- All Blocks --</option>
                    @foreach (var block in Model.Blocks)
                    {
                        <option value="@block">@block</option>
                    }
                </select>
            </div>
            <div class="form-group col-md-3">
                <label for="btnoSearch">BTNo</label>
                <input type="text" id="btnoSearch" class="form-control" placeholder="Search by BTNo" />
            </div>
            <div class="form-group col-md-1 d-flex align-items-end">
                <button type="button" id="btnSearch" class="btn btn-primary btn-block">Search</button>
            </div>
        </div>
    </div>
</div>

<div id="gridContainer">
    @await Html.PartialAsync("_MaintenanceCustomersGrid", Model.Customers)
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            function loadBlocks(project, selectedBlock) {
                return $.get('@Url.Action("GetBlocksByProject", "MaintenanceNew")',
                    { project: project },
                    function (data) {
                        var $block = $('#blockFilter');
                        $block.empty();
                        $block.append($('<option>').val('').text('-- All Blocks --'));
                        $.each(data, function (i, b) {
                            $block.append($('<option>').val(b).text(b));
                        });
                        if (selectedBlock) {
                            $block.val(selectedBlock);
                        }
                    });
            }

            function loadCustomers(page) {
                var project = $('#projectFilter').val();
                var block = $('#blockFilter').val();
                var btno = $('#btnoSearch').val();

                // Save search state
                var searchState = {
                    project: project,
                    block: block,
                    btno: btno,
                    page: page
                };
                sessionStorage.setItem('maintCustomerSearchState', JSON.stringify(searchState));

                $.get('@Url.Action("FilterCustomers", "MaintenanceNew")',
                    { project: project, block: block, btNo: btno, page: page },
                    function (html) {
                        $('#gridContainer').html(html);
                    });
            }

            $('#projectFilter').change(function () {
                var project = $(this).val();
                loadBlocks(project);
            });

            $('#btnSearch').click(function () {
                loadCustomers(1);
            });

            // Handle pagination clicks via AJAX
            $(document).on('click', '.pagination a', function (e) {
                e.preventDefault();
                var href = $(this).attr('href');
                if (href) {
                    var url = new URL(href, window.location.origin);
                    var page = url.searchParams.get("page");
                    loadCustomers(page);
                }
            });

            // Double-click event handler for viewing customer details
            $(document).on('dblclick', '#customersTable tbody tr', function () {
                var customerId = $(this).data('id');
                if (customerId) {
                    window.location.href = '@Url.Action("Details", "CustomersMaintenance")/' + customerId;
                }
            });

            // Restore search state if it exists
            var savedState = sessionStorage.getItem('maintCustomerSearchState');
            if (savedState) {
                var state = JSON.parse(savedState);
                $('#projectFilter').val(state.project);
                $('#btnoSearch').val(state.btno);
                
                if (state.project) {
                    loadBlocks(state.project, state.block).then(function() {
                        loadCustomers(state.page || 1);
                    });
                } else {
                    if (state.btno) {
                        loadCustomers(state.page || 1);
                    }
                }
            }
        });
    </script>
}
