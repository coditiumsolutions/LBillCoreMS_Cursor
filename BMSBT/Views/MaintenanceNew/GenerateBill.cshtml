@model IEnumerable<BMSBT.ViewModels.MaintSectorCustomersViewModel>
@using System.Text.Json
@{
    Layout = "~/Views/Shared/_LayoutMaintBills.cshtml";
    var accordionId = "accordionSectors";
    int count = 0;
    var selectedProject = ViewBag.SelectedProject as string;
    var btNoSearch = ViewBag.BTNoSearch as string;
    var projects = ViewBag.Projects as List<string> ?? new List<string>();
}

@{
    string operatorJson = Context.Session.GetString("OperatorSetupDetail");
    string operatorName = "", billingMonth = "", billingYear = "";

    if (!string.IsNullOrEmpty(operatorJson))
    {
        var setup = JsonSerializer.Deserialize<Dictionary<string, string>>(operatorJson);
        operatorName = setup.ContainsKey("OperatorName") ? setup["OperatorName"] : "";
        billingMonth = setup.ContainsKey("BillingMonth") ? setup["BillingMonth"] : "";
        billingYear = setup.ContainsKey("BillingYear") ? setup["BillingYear"] : "";
    }
}

<!-- Include Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

<!-- Optional: Loading overlay -->
<style>
    #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.7);
        z-index: 2000;
        display: none;
        align-items: center;
        justify-content: center;
    }

        #loadingOverlay .spinner-border {
            width: 3rem;
            height: 3rem;
        }
</style>

<div id="loadingOverlay">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div class="mb-3">
    <span class="fw-bold text-primary">Operator:</span> @operatorName |
    <span class="fw-bold text-primary">Billing Month:</span> @billingMonth |
    <span class="fw-bold text-primary">Billing Year:</span> @billingYear
</div>

<form method="get" asp-action="GenerateBill" asp-controller="MaintenanceNew">
    <div class="row mb-3">
        <div class="col-md-4">
            <label class="form-label fw-bold">Bills Not Generated</label>
            <select name="selectedProject" class="form-select" onchange="this.form.submit()">
                <option value="">-- Select Project --</option>
                @foreach (var project in projects)
                {
                    <option value="@project" selected="@(project == selectedProject ? "selected" : null)">@project</option>

                }
            </select>
        </div>
        @if (!string.IsNullOrEmpty(selectedProject))
        {
            <div class="col-md-4">
                <label class="form-label fw-bold">Search by BTNo:</label>
                <input type="text" name="btNoSearch" value="@btNoSearch" class="form-control" placeholder="Enter BTNo..." />
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">Search</button>
            </div>
        }
    </div>
    <button id="createRecordsButton" type="button" class="btn btn-success mb-3 me-2" style="width:150px">
        Generate Bill
    </button>
    <button id="generateMBillButton" type="button" class="btn btn-outline-primary mb-3" style="width:170px">
        Generate MBill
    </button>
</form>

<div class="accordion" id="@accordionId">
    @foreach (var group in Model)
    {
        var collapseId = $"collapse_{count}";
        var headingId = $"heading_{count}";
        <div class="accordion-item">
            <h2 class="accordion-header" id="@headingId">
                <button class="accordion-button collapsed" type="button"
                        data-bs-toggle="collapse" data-bs-target="#@collapseId"
                        aria-expanded="false" aria-controls="@collapseId">
                    Sector: @group.Sector <span class="ms-3 text-muted">(Total: @group.Customers.Count)</span>
                </button>
            </h2>
            <div id="@collapseId" class="accordion-collapse collapse"
                 aria-labelledby="@headingId" data-bs-parent="#@accordionId">
                <div class="accordion-body p-0">
                    <table class="table table-bordered table-striped mb-0">
                        <thead class="table-light">
                            <tr>
                                <th><input type="checkbox" onclick="toggleGroupCheckboxes(this, '@collapseId')" /></th>
                                <th>BT Number</th>
                                <th>Customer Name</th>
                                <th>CNIC No</th>
                                <th>Mobile No</th>
                                <th>SubProject</th>
                                <th>Block</th>
                                <th>Size</th>
                                <th>Bill Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var customer in group.Customers)
                            {
                                <tr ondblclick="window.location.href='@Url.Action("ViewCustomer", "SGCustomers", new { id = customer.Uid })'" style="cursor: pointer;">
                                    <td>
                                        <input type="checkbox" name="selectedCustomers"
                                               value="@customer.Uid"
                                               class="record-checkbox checkbox-@collapseId" />
                                    </td>
                                    <td>@customer.BTNo</td>
                                    <td>@customer.CustomerName</td>
                                    <td>@customer.City</td>
                                    <td>@customer.Project</td>
                                    <td>@customer.SubProject</td>
                                    <td>@customer.Block</td>
                                    <td>@customer.Size</td>
                                    <td>@customer.BillStatusMaint</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        count++;
    }
</div>

<!-- Include jQuery and Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJ+Y3TSLRmXX2mY+6pLDcXul5/6p1w5IBXtk=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // expose Razor vars to JS
    var currentProject = "@selectedProject";
    var currentMonth   = "@billingMonth";
    var currentYear    = "@billingYear";

    function toggleGroupCheckboxes(source, groupId) {
        var selector = '.checkbox-' + groupId;
        var checked = source.checked;
        document.querySelectorAll(selector).forEach(cb => cb.checked = checked);
    }

    $(document).ready(function () {
        function getSelectedIds() {
            return $('.record-checkbox:checked').map(function () {
                return +this.value;
            }).get();
        }

        $('#createRecordsButton').click(function () {
            var selectedIds = getSelectedIds();

            if (!selectedIds.length) {
                alert('No records selected.');
                return;
            }

            $('#loadingOverlay').show();

            $.ajax({
                url: '@Url.Action("GenerateMaintenanceBills", "MaintenanceNew")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    SelectedIds: selectedIds,
                    Project:    currentProject,
                    Month:      currentMonth,
                    Year:       currentYear
                }),
                success: function (response) {
                    $('#loadingOverlay').hide();
                    if (response.success) {
                        alert('Operation completed successfully!');
                    } else {
                        alert('Warning: ' + response.message);
                    }
                },
                error: function (xhr) {
                    $('#loadingOverlay').hide();
                    if (xhr.status === 403) {
                        alert('Unauthorized!');
                        window.location.href = '@Url.Action("AccessDenied", "Login")';
                    } else {
                        alert('An error occurred.');
                    }
                }
            });
        });

        // New: Generate MBill using default 15-values logic via isolated insert API
        $('#generateMBillButton').click(function () {
            var selectedIds = getSelectedIds();

            if (!selectedIds.length) {
                alert('No records selected.');
                return;
            }

            $('#loadingOverlay').show();

            $.ajax({
                url: '/api/MaintenanceBillInsert/from-customers',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(selectedIds),
                success: function (response) {
                    $('#loadingOverlay').hide();
                    if (response && response.success) {
                        alert(response.message || 'MBills generated successfully.');
                    } else {
                        alert('MBill generation completed, but response was unexpected.');
                    }
                },
                error: function (xhr) {
                    $('#loadingOverlay').hide();
                    if (xhr.status === 403) {
                        alert('Unauthorized!');
                        window.location.href = '@Url.Action("AccessDenied", "Login")';
                    } else {
                        var errorMsg = 'An error occurred while generating MBills.';
                        if (xhr.responseJSON && xhr.responseMsg) {
                             errorMsg = xhr.responseJSON.message;
                        } else if (xhr.responseText) {
                            try {
                                var res = JSON.parse(xhr.responseText);
                                if (res.message) errorMsg = res.message;
                            } catch(e) {}
                        }
                        alert(errorMsg);
                    }
                }
            });
        });
    });
</script> 