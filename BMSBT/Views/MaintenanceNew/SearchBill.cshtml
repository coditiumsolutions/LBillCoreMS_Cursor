@using BMSBT.DTO
@using X.PagedList
@using X.PagedList.Mvc.Core
@model IPagedList<MaintenanceBillDTO>

@{
    Layout = "~/Views/Shared/_LayoutMaintBills.cshtml";
    // If Model is null, use an empty list to avoid null reference errors.
    var bills = Model ?? new StaticPagedList<MaintenanceBillDTO>(new List<MaintenanceBillDTO>(), 1, 10000, 0);

    // Group the bills first by Project, then by Block.
    var groupedByProject = bills.GroupBy(b => b.Project)
        .Select(projGroup => new
        {
            Project = projGroup.Key,
            Blocks = projGroup.GroupBy(b => b.Block).OrderBy(bg => bg.Key)
        });
}




<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
    <div class="loading-text">Printing Bills...</div>
</div>

<style>
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-radius: 50%;
        border-top: 5px solid #3498db;
        animation: spin 1s linear infinite;
    }

    .loading-text {
        color: white;
        margin-top: 20px;
        font-size: 18px;
        font-weight: bold;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>



<!-- Optional messages -->
@if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
{
    <div class="alert alert-danger">@ViewBag.ErrorMessage</div>
}
@if (!string.IsNullOrEmpty(ViewBag.SuccessMessage))
{
    <div class="alert alert-success">@ViewBag.SuccessMessage</div>
}

<!-- Filter Form (for Month/Year) -->
<form method="post" action="@Url.Action("SearchBill", "MaintenanceNew")">
    <div class="row">
        <div class="col-md-3">
            <label for="month" class="form-label">Month:</label>
            <select id="month" name="month" class="form-control" >
                <option value="">-- Choose Month --</option>
                @foreach (var monthName in System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.MonthNames.Take(12))
                {
                    <option value="@monthName">@monthName</option>
                }
            </select>
        </div>
        <div class="col-md-3">
            <label for="year" class="form-label">Year:</label>
            <select id="year" name="year" class="form-control" >
                <option value="">-- Choose Year --</option>
                @for (int i = DateTime.Now.Year; i >= DateTime.Now.Year - 10; i--)
                {
                    <option value="@i">@i</option>
                }
            </select>
        </div>
        <div class="col-md-3">
            <label for="btno" class="form-label">BTNo:</label>
            <input type="text" id="btno" name="btno" class="form-control" placeholder="Enter BTNo"  />
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <div class="w-100 d-flex gap-2">
                <button type="submit" class="btn btn-primary w-50" style="margin-left:-10px">Search</button>
                <button id="PrintRecordsButton" type="button" class="btn btn-secondary w-50" style="margin-right:10px">Print Bill</button>
            </div>
        </div>
    </div>
</form>


<!-- Main Nested Table -->
<div class="table-responsive" style="margin-top:10px">
    <table id="maintenanceTable" class="table">
        <thead>
            <tr>
                <th style="width:50px;"></th>
                <th style="width:100px;">
                    <input type="checkbox" id="selectAll" title="Select All Records" />
                </th>

                <th data-sort="Btno" class="sort-icon" style="width:200px;">BT NO</th>
                <th data-sort="BillingMonth" class="sort-icon" style="width:200px;">Month</th>
                <th data-sort="BillingYear" class="sort-icon" style="width:150px;">Year</th>
                <th data-sort="Category" class="sort-icon" style="width:250px;">Category</th>
                <th data-sort="CustomerName" class="sort-icon" style="width:300px;">Customer Name</th>

                <th style="width:150px;">Maint Charges</th>
                <th style="width:150px;">Arrears</th>
                <th style="width:150px;">In Due Date</th>
                <th data-sort="PaymentStatus" class="sort-icon" style="width:150px;">Payment Status</th>

                <!-- Add other column headers as needed -->
            </tr>
        </thead>
        <tbody>
            @foreach (var projectGroup in groupedByProject)
            {
                var projectId = "project-" + projectGroup.Project?.Replace(" ", "-");
                <!-- Project Header Row -->
                <tr class="project-header" data-project="@projectId">
                    <td>
                        <i class="fas fa-chevron-right toggle-icon"></i>
                    </td>
                    <td colspan="10">
                        Project: @projectGroup.Project
                    </td>
                </tr>
                <!-- Project Content Row -->
                <tr class="project-content" data-parent="@projectId" style="display:none;">
                    <td colspan="11" style="padding:0;">
                        <div class="project-blocks">
                            @foreach (var blockGroup in projectGroup.Blocks)
                            {
                                var blockId = $"{projectId}-block-{blockGroup.Key?.Replace(" ", "-")}";
                                <!-- Block Header Row -->
                                <table class="nested-table" style="width:100%; margin-bottom:0;">
                                    <tr class="block-header" data-block="@blockId">
                                        <td style="width:50px;">
                                            <i class="fas fa-chevron-right toggle-icon"></i>
                                        </td>
                                        <td colspan="10">
                                            <strong>Block :</strong> @blockGroup.Key
                                        </td>
                                    </tr>
                                </table>
                                <!-- Block Content (with Category Grouping) -->
                                <div class="block-content" id="@blockId" style="display:none;">
                                    <table class="nested-table" style="width:100%; margin-bottom:0;">
                                        @foreach (var categoryGroup in blockGroup.GroupBy(b => b.Category).OrderBy(g => g.Key))
                                        {
                                            var categoryId = $"{blockId}-category-{categoryGroup.Key?.Replace(" ", "-")}";
                                            <!-- Category Header Row -->
                                            <tr class="category-header" data-category="@categoryId">
                                                <td style="width:50px;">
                                                    <i class="fas fa-chevron-right toggle-icon"></i>
                                                </td>
                                                <td colspan="10">
                                                    Category: @categoryGroup.Key
                                                </td>
                                            </tr>
                                            <!-- Category Content Rows -->
                                            <tr class="category-content" data-parent="@categoryId" style="display:none;">
                                                <td colspan="11" style="padding:0;">
                                                    <table class="nested-table" style="width:100%; margin-bottom:0;">
                                                        @foreach (var bill in categoryGroup)
                                                        {
                                                            <tr class="customer-row">
                                                                <td style="width:50px;"></td>
                                                                <td style="width:100px;">
                                                                    <input type="checkbox" class="record-checkbox" value="@bill.Uid" />
                                                                </td>
                                                                <td style="width:200px;">@bill.Btno</td>
                                                                <td style="width:200px;">@bill.BillingMonth</td>
                                                                <td style="width:150px;">@bill.BillingYear</td>
                                                                <td style="width:250px;">@bill.Category</td>
                                                                <td style="width:300px;">@bill.CustomerName</td>
                                                                <td style="width:150px;">@bill.MaintCharges?.ToString("N0")</td>
                                                                <td style="width:150px;">@bill.Arrears?.ToString("N0")</td>
                                                                <td style="width:150px;">@bill.BillAmountInDueDate?.ToString("N0")</td>
                                                                <td style="width:150px;">@bill.PaymentStatus</td>
                                                            </tr>
                                                        }
                                                    </table>
                                                </td>
                                            </tr>
                                        }
                                    </table>
                                </div>
                            }
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Results Container -->
<div id="resultsContainer" style="display:none; margin-top:20px;">
    <h4>Bill Generation Results</h4>
    <table id="resultsTable" class="table table-bordered">
        <thead>
            <tr>
                <th>#</th>
                <th>Result</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Optional styling (adapted from your CustomersDetail grid) -->
<style>
    .dropdown-container {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        align-items: center;
    }

    .custom-dropdown {
        width: 200px;
        height: 40px;
        padding: 5px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
    }

    .nested-table {
        width: 100%;
        margin-bottom: 0;
    }

    .toggle-icon {
        transition: transform 0.3s;
    }

    .rotate-icon {
        transform: rotate(90deg);
    }

    .search-panel {
        margin-bottom: 20px;
    }

    .project-header {
        background-color: #e3f2fd !important;
        cursor: pointer;
        padding-left: 10px;
    }

    /* Indent block headers (Sub Twistee) */
    .project-blocks {
        padding-left: 0;
    }

    /* Indent Block twistee table under Project */
    .project-blocks > .nested-table {
        margin-left: 30px;
        padding-left: 0;
    }

    .block-header {
        background-color: #f5f5f5 !important;
        cursor: pointer;
        padding-left: 10px;
    }

    /* Indent block content container */
    .block-content {
        padding-left: 30px; /* records / categories sit further right than Block header */
        margin-left: 0;
    }

    /* Indent category headers (Sub-Sub Twistee) */
    .block-content > .nested-table {
        margin-left: 0;
    }

    .category-header {
        background-color: #f0f8ff !important;
        cursor: pointer;
        padding-left: 10px;
    }

    /* Indent category content rows */
    .category-content {
        padding-left: 30px;
        margin-left: 0;
    }

    .category-content > .nested-table {
        margin-left: 0;
    }

    /* Ensure customer rows maintain proper alignment */
    .customer-row {
        padding-left: 0;
    }

    /* Responsive adjustments */
    @@media (max-width: 768px) {
        .block-content {
            padding-left: 20px;
        }
        .category-content {
            padding-left: 20px;
        }
    }

    @@media (max-width: 576px) {
        .block-content {
            padding-left: 15px;
        }
        .category-content {
            padding-left: 15px;
        }
    }
</style>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Toggle functionality for Project, Block, and Category rows
            $('.project-header').click(function () {
                var projectId = $(this).data('project');
                var icon = $(this).find('.toggle-icon');
                var content = $('tr[data-parent="' + projectId + '"]');
                icon.toggleClass('rotate-icon');
                content.toggle();
                if (!content.is(':visible')) {
                    content.find('.block-content, .category-content').hide();
                    content.find('.block-header .toggle-icon, .category-header .toggle-icon').removeClass('rotate-icon');
                }
            });
            $('.block-header').click(function (e) {
                e.stopPropagation();
                var blockId = $(this).data('block');
                var icon = $(this).find('.toggle-icon');
                var content = $('#' + blockId);
                icon.toggleClass('rotate-icon');
                content.toggle();
            });
            $('.category-header').click(function (e) {
                e.stopPropagation();
                var categoryId = $(this).data('category');
                var icon = $(this).find('.toggle-icon');
                var content = $('tr[data-parent="' + categoryId + '"]');
                icon.toggleClass('rotate-icon');
                content.toggle();
            });

            // Select All functionality for main table checkboxes
            $('#selectAll').change(function () {
                $('.record-checkbox:visible').prop('checked', $(this).prop('checked'));
                updateSelectAllState();
            });
            $('.record-checkbox').change(function () {
                updateSelectAllState();
            });
            function updateSelectAllState() {
                var totalVisible = $('.record-checkbox:visible').length;
                var totalChecked = $('.record-checkbox:visible:checked').length;
                $('#selectAll').prop({
                    checked: totalVisible === totalChecked && totalVisible > 0,
                    indeterminate: totalChecked > 0 && totalChecked < totalVisible
                });
            }

            // Print Bills Button Click
            $("#PrintRecordsButton").on("click", function () {
                console.log("Print button clicked");

                 $("#loadingOverlay").show();
                var selectedUIDs = [];
                $('.record-checkbox:checked').each(function() {
                    selectedUIDs.push($(this).val());
                });

                console.log("Selected UIDs:", selectedUIDs);

                if (selectedUIDs.length === 0) {
                    alert("Please select at least one bill to print.");
                    return;
                }

                // Show loading overlay
                $("#loadingOverlay").show();

                $.ajax({
                    url: '/MaintenanceNew/PrintMMultiBills',
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ uids: selectedUIDs.join(",") }),
                    xhrFields: {
                        responseType: 'blob'
                    },
                    beforeSend: function() {
                        console.log("Making AJAX request...");
                    },
                    success: function (data, status, xhr) {
                        console.log("Success response received");

                        var contentType = xhr.getResponseHeader("content-type");
                        if (contentType && contentType.indexOf("application/pdf") !== -1) {
                            var blob = new Blob([data], { type: "application/pdf" });
                            var url = window.URL.createObjectURL(blob);
                            window.open(url, "_blank"); // Open PDF in a new tab
                        } else {
                            alert("Received invalid response format from server");
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("AJAX Error:", {
                            status: xhr.status,
                            statusText: xhr.statusText,
                            error: error
                        });
                        alert("Failed to generate the bill. Status: " + xhr.status + ", Error: " + error);
                    },
                    complete: function () {
                        // Hide loading overlay after request completes
                             $("#loadingOverlay").hide();
                    }
                });
            });
        });
    </script>
}
