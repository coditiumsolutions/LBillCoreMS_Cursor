@model IEnumerable<BMSBT.Models.ElectricityBill>
@{
    ViewData["Title"] = "ElectricityBill";
    Layout = "~/Views/Shared/_LayoutEBills.cshtml";
}


<style>
    /* Container style */
    .dropdown-container {
        display: flex;
        gap: 10px; /* Space between dropdowns */
        justify-content: flex-start; /* Align dropdowns to the left */
        align-items: center; /* Align vertically */
    }

    /* Dropdown style */
    .custom-dropdown {
        width: 200px; /* Adjust width */
        height: 40px; /* Adjust height */
        padding: 5px; /* Add padding for better appearance */
        font-size: 14px; /* Adjust font size */
        border: 1px solid #ccc; /* Optional: Border styling */
        border-radius: 5px; /* Optional: Rounded corners */
        box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1); /* Optional: Subtle shadow */
    }

</style>
<form asp-action="GenerateEBill" method="post">
<div class="form-group dropdown-container">
        <select id="monthDropdown" name="monthDropdown" class="form-control custom-dropdown">
        <option value="">-- Select Month --</option>
    </select>
        <select id="yearDropdown" name="yearDropdown" class="form-control custom-dropdown">
        <option value="">-- Select Year --</option>
    </select>
</div>
<div class="gridContainer" id="customerGridContainer">
    <table id="studentsTable" class="table table-striped table-bordered dt-responsive nowrap" width="100%" cellspacing="0">
        <thead>
            <tr>
                <th>
                    Edit
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.InvoiceNo)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.CustomerNo)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.BillingMonth)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.BillingDate)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.DueDate)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.ReadingDate)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.IssueDate)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.ValidDate)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.MeterType)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.MeterNo)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.PaymentStatus)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.PaymentDate)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.PaymentMethod)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.BankDetail)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.LastUpdated)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.BillAmountInDueDate)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.BillSurcharge)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.BillAmountAfterDueDate)
                </th>
                <th></th>
            </tr>
        </thead>
        <tbody id="customerGridBody">
            <!-- This is where the partial view's rows will be inserted -->
        </tbody>
    </table>
    <button type="submit" class="btn btn-primary" style="margin-top:25px">Generate Bill</button>
</div>
</form>

<!-- jQuery (Required for DataTables) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">

<!-- DataTables JS -->
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>


<!-- Axios CDN (Place it above your custom script) -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>




<script>

    document.addEventListener('DOMContentLoaded', function () {
       // Initialize DataTable for the first time
       const table = $('#studentsTable').DataTable({
           paging: true,
           searching: true,
           lengthChange: true,
           pageLength: 10
       });

        axios.get('/ElectricityBills/GetMonths')
            .then(function (response) {
                const dropdown = document.getElementById('monthDropdown');
                response.data.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    dropdown.appendChild(option);
                });
            })
            .catch(function (error) {
                console.error('Error loading dropdown values:', error);
            });


            axios.get('/ElectricityBills/GetYears')
                .then(function (response) {
                    const dropdown = document.getElementById('yearDropdown');
                    response.data.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        dropdown.appendChild(option);
                    });
                })
                .catch(function (error) {
                    console.error('Error loading dropdown values:', error);
                });





         // Event listener for city dropdown change
        const monthDropdown = document.getElementById('monthDropdown');
        const yearDropdown = document.getElementById('yearDropdown');
        const customerGridBody = document.getElementById('customerGridBody');
              console.log("123");


                 // Function to update the grid
    function updateGrid() {

            const selectedMonth = monthDropdown.value;
            const selectedYear = yearDropdown.value;
            console.log(selectedMonth);
             console.log(selectedYear);
            if (selectedMonth && selectedYear) {
                axios.get(`/ElectricityBills/GetBillsByMonth?month=${encodeURIComponent(selectedMonth)}&year=${encodeURIComponent(selectedYear)}`)
                    .then(function (response) {
                     console.log(response.data);
                // Clear existing rows without destroying the table
                table.clear();

                 // Destroy the existing DataTable instance if it exists
                if ($.fn.DataTable.isDataTable('#studentsTable')) {
                    $('#studentsTable').DataTable().destroy();
                }

                customerGridBody.innerHTML = response.data;
                console.log("11111");
                // // Reinitialize DataTable after updating the grid
                $('#studentsTable').DataTable();
                console.log("22222");

              })

                .catch(function (error) {
                        console.error('Error loading customers:', error);
                    });
            } else {
                // If no city is selected, clear the grid and reinitialize DataTable with empty data
                customerGridBody.innerHTML = '';
               // table.clear().draw(); // Clear the DataTable and reset the data
             if ($.fn.DataTable.isDataTable('#studentsTable')) {
            $('#studentsTable').DataTable().clear().draw(); // Clear the DataTable if initialized
             // Important :    Same as above line: table.clear().draw(); // Clear the DataTable and reset the data
        }
            }



        }

            // Attach event listeners to both dropdowns
    monthDropdown.addEventListener('change', updateGrid);
    yearDropdown.addEventListener('change', updateGrid);



    });


      // Double-click event handler
    $('#studentsTable tbody').on('dblclick', 'tr', function () {
        var operatorId = $(this).data('id'); // Get the OperatorId from the row
        // You can change this URL to direct to your desired page, like Details or Edit
        window.location.href = '/ElectricityBills/Detail/' + operatorId; // Redirect to the Details page
    });

</script>




